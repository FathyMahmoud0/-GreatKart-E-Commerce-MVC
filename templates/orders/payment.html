{% extends 'base.html' %}
{% block content %}

<h2>Complete Your Payment</h2>
<p>Order Number: {{ order.order_number }}</p>
<p>Total: {{ order.grand_total }} USD</p>

<hr>
<div id="paypal-button-container"></div>

<script src="https://www.paypal.com/sdk/js?client-id=AbOv0wuQYmUwXiLdmEwZaF5MO1Ksa2MP_ZoDSB7NjjxYDeqJ-xK1x9en4SDschoxp8Qj4o-9De25EisV&currency=USD"></script>

{{ order.grand_total|json_script:"js-grand-total" }}
{{ order.order_number|json_script:"js-order-id" }}
{{ order_description|default:"Purchase from MyStore"|json_script:"js-order-description" }}
{{ currency_code|default:"USD"|json_script:"js-currency-code" }}

<script>
    // --- دالة جلب CSRF (لا تغيير) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    if (!csrftoken) {
        console.error("CSRF token is missing");
        alert("Error: CSRF token is missing. Please refresh the page.");
    }

    // --- قراءة البيانات الآمنة من json_script ---
    var total;
    var order_id;
    var order_description;
    var currency_code;
    var url = '{% url "order_payment" %}'; // (هذا الرابط يتم إنشاؤه بواسطة Django)
    var payment_method = 'paypal';

    try {
        total = JSON.parse(document.getElementById('js-grand-total').textContent);
        order_id = JSON.parse(document.getElementById('js-order-id').textContent);
        order_description = JSON.parse(document.getElementById('js-order-description').textContent);
        currency_code = JSON.parse(document.getElementById('js-currency-code').textContent);

        if (isNaN(total) || total <= 0) {
            throw new Error("Invalid total amount");
        }
        if (!order_id) {
            throw new Error("Order ID is missing");
        }
        total = total.toFixed(2);

    } catch (e) {
        console.error("Error reading data from Django:", e.message);
        alert("Error: Could not load order details. Please try again. " + e.message);
    }

    // --- دالة fetch كاملة مع معالجة الرد ---
    function order_completed(details) {
        
        const bodyData = {
            orderID: order_id, // (من json_script)
            PaymentId: details.id, // (من PayPal)
            paymentMethod: payment_method,
            Status: details.status || 'UNKNOWN', // (من PayPal)
        };

        console.log("Body to be sent:", JSON.stringify(bodyData));

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(bodyData),
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    throw new Error(errData.message || `HTTP error! Status: ${response.status}`);
                });
            }
            return response.json(); 
        })
        .then(data => {
            console.log("Server response:", data);
            if (data.success) {
                // نجحت العملية!
                alert("Payment successful! Redirecting...");
                // (غيّر هذا الرابط إلى صفحة "شكراً لك" الفعلية)
                window.location.href = '/order_success_page/'; 
            } else {
                alert("Payment failed: " + (data.message || "Unknown error"));
            }
        })
        .catch(error => {
            console.error("Fetch Error:", error);
            alert("An error occurred while finalizing the payment: " + error.message);
        });
    }

    // --- كود PayPal (لا تغييرات) ---
    if (typeof paypal === 'undefined' || !paypal.Buttons) {
        console.error("PayPal SDK not loaded");
        alert("Error: PayPal SDK not loaded. Please check your internet connection.");
    } else {
        paypal.Buttons({
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        description: order_description,
                        amount: {
                            currency_code: currency_code,
                            value: total
                        }
                    }]
                });
            },
            onApprove: function(data, actions) {
                document.querySelector("#paypal-button-container").innerHTML = "<h3>Processing...</h3>";
                return actions.order.capture().then(function(details) {
                    if (details.id && details.status) {
                        order_completed(details);
                    } else {
                        console.error("PayPal capture details missing:", details);
                        alert("Error: Could not capture payment details from PayPal.");
                    }
                });
            },
            onCancel: function(data) {
                alert("Payment cancelled");
            },
            onError: function(err) {
                console.error("PayPal Button Error:", err);
                alert("An error occurred with the PayPal transaction.");
            }
        }).render("#paypal-button-container");
    }
</script>

{% endblock content %}